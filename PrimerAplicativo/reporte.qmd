---
title: "Informe Estadístico"
format: html
execute:
  echo: false
params:
  data_path: null
  var_cual_param: null  
  var_cuan1_param: null 
  var_cuan2_param: null 
  color_param: "blue"   
---

```{r}
#| include: false
library(tidyverse)
library(readxl)
library(kableExtra)
library(formattable)
datos <- readRDS(params$data_path)
```

## Informe sobre créditos aperturados en una entidad financiera

En las siguientes líneas se resume la información de las `r nrow(datos)` solicitudes de créditos aperturadas en las Coop. Paquito en el periodo entre `r min(datos$FECHAADJUDICACION)` y `r max(datos$FECHAADJUDICACION)`

### Créditos otorgados a nivel de provincia

```{r}
#| include: false
res01 <- datos %>% group_by(PROVINCIA_DOMICILIO) %>% summarise(Creditos = n(), Monto = mean(MONTO_OTORGADO)) %>% mutate(Porcentaje = round(100*Creditos/sum(Creditos),2)) %>% arrange(desc(Creditos))
```

Las tres provincias con mayor número de créditos son: `r res01$PROVINCIA_DOMICILIO[1]`, `r res01$PROVINCIA_DOMICILIO[2]` y `r res01$PROVINCIA_DOMICILIO[3]` con el `r paste0(res01$Porcentaje[1], "%")`, `r paste0(res01$Porcentaje[2], "%")` y `r paste0(res01$Porcentaje[3], "%")`, respectivamente.

Por otra parte, se comparte los montos promedio de créditos solicitados en cada provincia:

```{r}
#| echo: false
tb01 <- res01 %>% arrange(desc(Monto)) %>% select(PROVINCIA_DOMICILIO, Monto) %>% mutate(Monto = paste("$", round(Monto, 2)))
colnames(tb01) <- c("Provincia", "Monto")
tb01 %>% kable(caption = "Resumen de montos promedio de crédito por Provincia") %>% 
      kable_paper(full_width = F, font_size = 18) %>% 
      row_spec(0, bold = T, color = "white", background = "#1FA123") %>% 
      row_spec(1:3, bold = T, color = "white", background = "#224EC7")
```

```{r}
#| echo: false
# Buscar columna de profesión
profesion_col <- names(datos)[grep("PROFESION|profesion|Profesion", names(datos))][1]

# Crear resumen simple por profesión
if (!is.na(profesion_col)) {
  res_profesion <- datos %>%
    rename(Profesion = all_of(profesion_col)) %>%
    count(Profesion) %>%
    mutate(Porcentaje = round(100 * n / sum(n), 2)) %>%
    arrange(desc(n)) %>%
    rename(Creditos = n)
  
  top_profesiones <- head(res_profesion, 3)
}
```
### Créditos otorgados a nivel de profesión

`r if (!is.na(profesion_col)) { paste0("Las tres profesiones con más créditos son: ", top_profesiones$Profesion[1], " (", top_profesiones$Porcentaje[1], "%), ", top_profesiones$Profesion[2], " (", top_profesiones$Porcentaje[2], "%) y ", top_profesiones$Profesion[3], " (", top_profesiones$Porcentaje[3], "%).") } else { "No se encontró información de profesiones en los datos." }`

```{r}
#| echo: false
if (!is.na(profesion_col)) {
  res_profesion %>%
    head(10) %>%
    select(Profesion, Creditos, Porcentaje) %>%
    kable(caption = "Top 10 Profesiones con Más Créditos") %>% 
    kable_paper(full_width = FALSE, font_size = 14) %>% 
    row_spec(0, bold = TRUE, color = "white", background = "#132b60")
} else {
  data.frame(Información = "Datos de profesión no disponibles") %>%
    kable() %>% 
    kable_paper(full_width = FALSE, font_size = 14)
}

```
### Resumen de activos, crédito y mora por Sexo y Número de cargas
A continuación, se presenta un resumen de los activos totales, monto promedio de crédito otorgado y días promedio de mora según el sexo del solicitante y el número de cargas familiares que poseen:

```{r}
#| echo: false
#| message: false
#| warning: false

# Cálculo según Sexo y Número de cargas
moraSCP <- datos %>%
  filter(!is.na(TOTALACTIVOS)) %>%
  group_by(SEXO, NUMERO_CARGAS) %>% 
  summarise(
    Min_TOTALACTIVOS = min(TOTALACTIVOS, na.rm = TRUE),
    Max_TOTALACTIVOS = max(TOTALACTIVOS, na.rm = TRUE),
    Promedio_MontoCredito = mean(MONTO_OTORGADO, na.rm = TRUE),
    Promedio_DiasMora = mean(DIAS_MORA_CON_TRAD, na.rm = TRUE)
  ) %>% 
  mutate(
    Min_TOTALACTIVOS = paste('$', round(Min_TOTALACTIVOS, 2)),
    Max_TOTALACTIVOS = paste('$', round(Max_TOTALACTIVOS, 2)),
    Promedio_MontoCredito = paste('$', round(Promedio_MontoCredito, 2)),
    Promedio_DiasMora = round(Promedio_DiasMora, 4)
  )

colnames(moraSCP) <- c(
  'Sexo', 'Número Cargas', 'Min Total Activos', 
  'Max Total Activos', 'Promedio Monto Crédito', 'Promedio Días Mora'
)

moraSCP %>% 
  kable(caption = 'Resumen de Activos, Monto de Crédito y Días de Mora según Sexo y Número de Cargas') %>% 
  kable_paper(full_width = F, font_size = 18) %>% 
  row_spec(0, bold = T, color = "white", background = "#9C27B0") %>% 
  row_spec(1:6, bold = T, color = "black", background = "#E1BEE7")
```
### Resumen realizado a partir de grupos por edades
A continuación se presenta lo obtenido al dividir a los individuos en funcion de sus edades en grupos determinados.
```{r}
#| message: false
#| warning: false
#| include: false
res04 <- datos %>%
mutate(
FECHANACIMIENTO = as.Date(FECHANACIMIENTO),
EDAD = floor(interval(FECHANACIMIENTO, Sys.Date()) / years(1)),
GRUPO_EDAD = cut(
EDAD,
breaks = c(18, 24, 31, 39, 49, 59, 100),
labels = c("18-24", "25-31", "32-39", "40-49", "50-59", "60-100"),
right = FALSE
),
RATIO_ENDEUDAMIENTO = MONTO_OTORGADO / TOTALINGRESOS
) %>%
filter(
TOTALINGRESOS >= quantile(TOTALINGRESOS, 0.02, na.rm = TRUE) &
TOTALINGRESOS <= quantile(TOTALINGRESOS, 0.98, na.rm = TRUE)
) %>%
group_by(GRUPO_EDAD) %>%
summarise(
N = n(),
INGRESO_PROMEDIO = mean(TOTALINGRESOS, na.rm = TRUE),
MONTOCREDITO_PROMEDIO = mean(MONTO_OTORGADO, na.rm = TRUE),
RATIO_ENDEUDAMIENTO_PROM = mean(RATIO_ENDEUDAMIENTO, na.rm = TRUE)
)
```

```{r}
#| echo: false
#| message: false
#| warning: false
res04_long <- res04 %>%
pivot_longer(cols = c(INGRESO_PROMEDIO, MONTOCREDITO_PROMEDIO),
names_to = "Variable", values_to = "Valor")

ggplot(res04_long, aes(x = GRUPO_EDAD, y = Valor, fill = Variable)) +
geom_col(position = "dodge") +
scale_fill_manual(values = c("#0072B2", "#E69F00")) +
labs(title = "Ingreso vs Crédito Promedio por Grupo de Edad",
x = "Grupo de Edad", y = "Promedio (USD)") +
theme_minimal()
```

```{r}
#| echo: false
#| message: false
#| warning: false
ggplot(res04, aes(x = GRUPO_EDAD, y = N)) +
geom_col(fill = "#0072B2") +
geom_text(aes(label = N), vjust = -0.5) +
labs(title = "Cantidad de Personas por Grupo de Edad",
x = "Grupo de Edad", y = "Número de personas") +
theme_minimal()
```